{% extends "base.html" %}
{% block title %}Admin - Relatórios{% endblock %}
{% block content %}
<h1>Relatórios</h1>

<form method="get" action="{{ url_for('admin_reports') }}">
  <div style="display:grid; grid-template-columns: repeat(4, minmax(140px,1fr)); gap:12px; max-width:900px;">
    <div>
      <label>Início</label>
      <input type="date" name="start" value="{{ start }}">
    </div>
    <div>
      <label>Fim</label>
      <input type="date" name="end" value="{{ end }}">
    </div>
    <div>
      <label>Usuário</label>
      <select name="user_id">
        <option value="">-- Todos --</option>
        {% for u in users %}
          <option value="{{ u.id }}" {% if selected_user_id == u.id %}selected{% endif %}>{{ u.username }}</option>
        {% endfor %}
      </select>
    </div>
    <div style="align-self:end;">
      <button class="btn" type="submit">Filtrar</button>
    </div>
  </div>
</form>

<p style="margin-top:12px;">
  <a class="btn secondary" href="{{ url_for('admin_reports_csv', start=start, end=end, user_id=selected_user_id) }}" target="_blank">Exportar CSV (filtrado)</a>
</p>
<p style="margin-top:8px;">
  <a class="btn" href="{{ url_for('admin_reports_xlsx', start=start, end=end, user_id=selected_user_id) }}" target="_blank">Baixar XLSX (filtrado)</a>
</p>

<h2>Gráficos</h2>
<div style="max-width:980px;">
  <canvas id="chartByDay" height="120"></canvas>
</div>
<div style="max-width:980px; margin-top:18px;">
  <canvas id="chartByDevice" height="140"></canvas>
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
async function loadCharts() {
  const params = new URLSearchParams(window.location.search);
  const res = await fetch(`/admin/reports_data.json?${params.toString()}`);
  const data = await res.json();

  const byDayLabels = data.by_day.map(x => x.date);
  const byDayValues = data.by_day.map(x => x.sum);

  const ctx1 = document.getElementById('chartByDay').getContext('2d');
  new Chart(ctx1, {
    type: 'line',
    data: { labels: byDayLabels, datasets: [{ label: 'Fusões por dia', data: byDayValues }] },
    options: { responsive: true, maintainAspectRatio: false }
  });

  const byDeviceLabels = data.by_device.map(x => x.device_name);
  const byDeviceValues = data.by_device.map(x => x.sum);
  const ctx2 = document.getElementById('chartByDevice').getContext('2d');
  new Chart(ctx2, {
    type: 'bar',
    data: { labels: byDeviceLabels, datasets: [{ label: 'Fusões por dispositivo', data: byDeviceValues }] },
    options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false }
  });
}
loadCharts();
</script>

<h2>Totais</h2>
<p><strong>Soma de fusões:</strong> {{ total_fusions }}</p>

<h2>Dispositivos (soma por dispositivo)</h2>
{% if devices %}
  <table class="table">
    <tr><th>Dispositivo</th><th>Registros</th><th>Fusões (soma)</th></tr>
    {% for d in devices %}
      <tr>
        <td>{{ d.device_name }}</td>
        <td>{{ d.registros }}</td>
        <td>{{ d.fusoes }}</td>
      </tr>
    {% endfor %}
  </table>
{% else %}
  <p>Nenhum dispositivo no filtro.</p>
{% endif %}

<h2>Totais por Usuário (no período)</h2>
<p>
  <a class="btn secondary" href="{{ url_for('admin_reports_users_csv', start=start, end=end, user_id=selected_user_id) }}" target="_blank">
    Exportar CSV (por usuário)
  </a>
</p>
{% if users_summary %}
  <table class="table">
    <tr><th>User ID</th><th>Usuário</th><th>Dispositivos distintos</th><th>Registros</th><th>Fusões (soma)</th></tr>
    {% for u in users_summary %}
      <tr>
        <td>{{ u.id }}</td>
        <td>{{ u.username }}</td>
        <td>{{ u.devices }}</td>
        <td>{{ u.registros }}</td>
        <td>{{ u.fusoes }}</td>
      </tr>
    {% endfor %}
  </table>
{% else %}
  <p>Sem dados para este período/filtro.</p>
{% endif %}

<h2>Detalhes</h2>
{% if rows %}
  <table class="table">
    <tr><th>ID</th><th>Usuário</th><th>Dispositivo</th><th>Fusões</th><th>Criado em</th></tr>
    {% for r in rows %}
      <tr>
        <td>{{ r.id }}</td>
        <td>{{ r.username }}</td>
        <td>{{ r.device_name }} <a class='btn secondary' href='{{ url_for("view_record", record_id=r.id) }}'>Abrir</a></td>
        <td>{{ r.fusion_count }}</td>
        <td>{{ r.created_at }}</td>
      </tr>
    {% endfor %}
  </table>
{% else %}
  <p>Sem registros para o filtro selecionado.</p>
{% endif %}

<p style="margin-top:16px;"><a class="btn secondary" href="{{ url_for('admin_home') }}">Voltar</a></p>
{% endblock %}
